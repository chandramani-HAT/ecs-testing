name: CD - Deploy to Amazon ECS

on:
  push:
    branches:
      - feature-prod-i

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: aquiflow
  ECS_SERVICE: aquiflow
  CF_STACK_NAME: aquiflow-ecs-stack
  TARGET_ENV: prod

jobs:
  prepare:
    name: Prepare Deployment
    runs-on:
      - codebuild-ecs-workflow-${{ github.run_id }}-${{ github.run_attempt }}
    
    permissions:
      contents: read
    
    outputs:
      docker-image-uri: ${{ steps.read-config.outputs.dockerImageUri }}
      commit-hash: ${{ steps.read-config.outputs.commitHash }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read configuration
        id: read-config
        run: |
          echo "ğŸ“– Reading configuration from config.json"
          
          # Check if config.json exists
          if [ ! -f config.json ]; then
            echo "âŒ Error: config.json not found!!!"
            exit 1
          fi
          
          # Read config.json and extract parameters
          DOCKER_IMAGE_URI=$(jq -r '.docker_image_uri' config.json)
          COMMIT_HASH=$(jq -r '.commit_hash' config.json)
          
          # Validate required fields
          if [ "$DOCKER_IMAGE_URI" == "null" ] || [ -z "$DOCKER_IMAGE_URI" ]; then
            echo "âŒ Error: docker_image_uri is missing in config.json"
            exit 1
          fi
          
          if [ "$COMMIT_HASH" == "null" ] || [ -z "$COMMIT_HASH" ]; then
            echo "âŒ Error: commit_hash is missing in config.json"
            exit 1
          fi
          
          # Set outputs
          echo "dockerImageUri=$DOCKER_IMAGE_URI" >> $GITHUB_OUTPUT
          echo "commitHash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          
          echo "âœ… Configuration loaded successfully"
          echo "Docker Image URI: $DOCKER_IMAGE_URI"
          echo "Commit Hash: $COMMIT_HASH"

  approval:
    name: Manual Approval Required
    needs: prepare
    runs-on:
      - codebuild-ecs-workflow-${{ github.run_id }}-${{ github.run_attempt }}
    
    permissions:
      contents: read
    
    environment:
      name: production
      url: https://prod-aquiflow.com
    
    steps:
      - name: Wait for approval
        run: |
          echo "â³ Waiting for manual approval..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Docker Image: ${{ needs.prepare.outputs.docker-image-uri }}"
          echo "Commit Hash: ${{ needs.prepare.outputs.commit-hash }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Please review and approve in GitHub UI"

  deploy:
    name: Deploy to ECS via CloudFormation
    needs: [prepare, approval]
    runs-on:
      - codebuild-ecs-workflow-${{ github.run_id }}-${{ github.run_attempt }}
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update CloudFormation Stack
        id: update-stack
        run: |
          echo "ğŸš€ Updating CloudFormation stack: ${{ env.CF_STACK_NAME }}"
          echo "Docker Image URI: ${{ needs.prepare.outputs.docker-image-uri }}"
          
          # Update CloudFormation stack with docker image URI
          aws cloudformation update-stack \
            --stack-name ${{ env.CF_STACK_NAME }} \
            --use-previous-template \
            --parameters \
              ParameterKey=DockerImageUri,ParameterValue="${{ needs.prepare.outputs.docker-image-uri }}" \
              ParameterKey=CommitHash,ParameterValue="${{ needs.prepare.outputs.commit-hash }}" \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} || {
              echo "âš ï¸ No changes detected or stack update failed"
              exit 0
            }
          
          # Wait for stack update to complete
          echo "â³ Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.CF_STACK_NAME }} \
            --region ${{ env.AWS_REGION }} || {
              echo "â„¹ï¸ Stack update completed with no changes"
            }
          
          echo "âœ… CloudFormation stack updated successfully"
      
      - name: Get Updated Resources
        id: get-resources
        run: |
          echo "ğŸ“‹ Fetching updated resource information..."
          
          # Get Task Definition ARN from CloudFormation stack
          TASK_DEF_ARN=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.CF_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TaskDefinitionArn`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          echo "task-def-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Task Definition: $TASK_DEF_ARN"
      
      - name: Verify ECS Service Deployment
        run: |
          echo "ğŸ” Verifying ECS service deployment..."
          
          # Wait for service to stabilize
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Service is stable"
      
      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Stack: ${{ env.CF_STACK_NAME }}"
          echo "Cluster: ${{ env.ECS_CLUSTER }}"
          echo "Service: ${{ env.ECS_SERVICE }}"
          echo "Task Definition: ${{ steps.get-resources.outputs.task-def-arn }}"
          echo "Docker Image: ${{ needs.prepare.outputs.docker-image-uri }}"
          echo "Commit Hash: ${{ needs.prepare.outputs.commit-hash }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Display service status
          echo ""
          echo "ğŸ“Š Service Status:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,status,runningCount,desiredCount,deployments[0].status]' \
            --output table
      
      - name: Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful to ${{ env.TARGET_ENV }}!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
