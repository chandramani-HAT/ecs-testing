name: CD - Deploy to Amazon ECS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
        default: 'dev'

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: aquiflow
  ECS_SERVICE: aquiflow
  CF_STACK_NAME: aquiflow-ecs-stack

jobs:
  prepare:
    name: Prepare Deployment
    runs-on:
      - codebuild-ecs-workflow-${{ github.run_id }}-${{ github.run_attempt }}
    
    permissions:
      contents: read
    
    outputs:
      config-params: ${{ steps.read-config.outputs.params }}
      image-tag: ${{ steps.read-config.outputs.imageTag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read configuration
        id: read-config
        run: |
          echo "ğŸ“– Reading configuration from config.json"
          
          # Read config.json and extract parameters
          IMAGE_TAG=$(jq -r '.imageTag // "latest"' config.json)
          CPU=$(jq -r '.cpu // "256"' config.json)
          MEMORY=$(jq -r '.memory // "512"' config.json)
          DESIRED_COUNT=$(jq -r '.desiredCount // "1"' config.json)
          CONTAINER_PORT=$(jq -r '.containerPort // "80"' config.json)
          
          # Set outputs
          echo "imageTag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          # Create parameter overrides JSON for CloudFormation
          PARAMS=$(jq -n \
            --arg tag "$IMAGE_TAG" \
            --arg cpu "$CPU" \
            --arg memory "$MEMORY" \
            --arg count "$DESIRED_COUNT" \
            --arg port "$CONTAINER_PORT" \
            '{
              ImageTag: $tag,
              TaskCpu: $cpu,
              TaskMemory: $memory,
              DesiredCount: $count,
              ContainerPort: $port
            }')
          
          echo "params=$PARAMS" >> $GITHUB_OUTPUT
          echo "âœ… Configuration loaded successfully"
          echo "$PARAMS" | jq .

  approval:
    name: Manual Approval Required
    needs: prepare
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://aquiflow.com
    
    steps:
      - name: Wait for approval
        run: |
          echo "â³ Waiting for manual approval..."
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Image Tag: ${{ needs.prepare.outputs.image-tag }}"
          echo "Please review and approve in GitHub UI"

  deploy:
    name: Deploy to ECS via CloudFormation
    needs: [prepare, approval]
    runs-on:
      - codebuild-ecs-workflow-${{ github.run_id }}-${{ github.run_attempt }}
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update CloudFormation Stack
        id: update-stack
        run: |
          echo "ğŸš€ Updating CloudFormation stack: ${{ env.CF_STACK_NAME }}"
          
          # Parse parameters from previous job
          PARAMS='${{ needs.prepare.outputs.config-params }}'
          
          # Convert JSON to CloudFormation parameter format
          CF_PARAMS=$(echo "$PARAMS" | jq -r 'to_entries | map("ParameterKey=\(.key),ParameterValue=\(.value)") | join(" ")')
          
          # Update CloudFormation stack
          aws cloudformation update-stack \
            --stack-name ${{ env.CF_STACK_NAME }} \
            --use-previous-template \
            --parameters $CF_PARAMS \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} || true
          
          # Wait for stack update to complete
          echo "â³ Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.CF_STACK_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… CloudFormation stack updated successfully"
      
      - name: Get Updated Resources
        id: get-resources
        run: |
          echo "ğŸ“‹ Fetching updated resource information..."
          
          # Get Task Definition ARN from CloudFormation stack
          TASK_DEF_ARN=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.CF_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`TaskDefinitionArn`].OutputValue' \
            --output text \
            --region ${{ env.AWS_REGION }})
          
          echo "task-def-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "Task Definition: $TASK_DEF_ARN"
      
      - name: Verify ECS Service Deployment
        run: |
          echo "ğŸ” Verifying ECS service deployment..."
          
          # Wait for service to stabilize
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… Service is stable"
      
      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Stack: ${{ env.CF_STACK_NAME }}"
          echo "Cluster: ${{ env.ECS_CLUSTER }}"
          echo "Service: ${{ env.ECS_SERVICE }}"
          echo "Task Definition: ${{ steps.get-resources.outputs.task-def-arn }}"
          echo "Image Tag: ${{ needs.prepare.outputs.image-tag }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Display service status
          echo ""
          echo "ğŸ“Š Service Status:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].[serviceName,status,runningCount,desiredCount,deployments[0].status]' \
            --output table
      
      - name: Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful to ${{ github.event.inputs.environment }}!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
